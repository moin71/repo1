/****** Object:  StoredProcedure [EDWH_FACT].[EGY_TO_EDWH_FACT_PAYMENT_GATEWAY]    Script Date: 11/27/2023 4:18:09 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [EDWH_FACT].[EGY_TO_EDWH_FACT_PAYMENT_GATEWAY] AS

DECLARE @UAEDATE DATETIME;

BEGIN

SET @UAEDATE = (SELECT  udo.GETDATE(GETDATE(),(SELECT [TIME_ADJUSTMENT] FROM [udo].[TIME_CONFIG] WHERE
DATE = CAST(GETDATE() AS DATE))));

DELETE FROM EDWH_FACT.FACT_PAYMENT_GATEWAY
WHERE DS = 23 
AND TRANSACTION_DATE = DATEADD(D,DATEDIFF(D,0,@UAEDATE),0) - 1;

INSERT INTO EDWH_FACT.FACT_PAYMENT_GATEWAY
SELECT 23 DS, 
'ID_2.40' ETL_ID, 
@UAEDATE INSERT_DATETIME, 
@UAEDATE UPDATE_DATETIME, 
CASE WHEN TRANS_ID iS NULL THEN -1 ELSE CAST(CONCAT(TRANS_ID,2) AS BIGINT) END TRANSACTION_KEY, 
TRANS_ID TRANSACTION_NUMBER, 
CAST(TRANSACTIONSTARTDATE AS DATE) TRANSACTION_DATE, 
CASE WHEN CUSTOMER_NO IS NULL THEN -1 ELSE CAST(CONCAT(ltrim(rtrim(CUSTOMER_NO)),2) AS BIGINT) END SUBSCRIBER_KEY,
CASE WHEN FINANCEACCOUNTNUMBER IS NULL THEN -1 ELSE CAST(CONCAT(ltrim(rtrim(FINANCEACCOUNTNUMBER)),2) AS BIGINT) END ACCOUNT_KEY, 
ISNULL(T2.USER_KEY, -1) USER_KEY, 
ISNULL(T4.CURRENCY_KEY, -1) CURRENCY_KEY, 
NULL FT_KEY, 
NULL INVOICE_KEY, 
CASE WHEN T1.PAYMENTTRANSACTIONTYPEID IS NULL THEN -1 ELSE CAST(CONCAT(ltrim(rtrim(T1.PAYMENTTRANSACTIONTYPEID)),2) AS BIGINT) END TRANSACTION_TYPE_KEY, 
ltrim(rtrim(T1.RESCODE)) TRANSACTION_RESPONSE_CODE, 
ltrim(rtrim(T1.MODE)) COLLECTION_MODE, 
TRANSACTIONSTARTDATE TRANSACTION_DATETIME, 
ltrim(rtrim(AUTHCODE)) TRANSACTION_STATUS, 
ltrim(rtrim(ERRTEXT)) TRANSACTION_RESPONSE, 
ltrim(rtrim(CARD_NO)) CREDIT_CARD_NUMBER, 
ltrim(rtrim(CARDTYPE)) CREDIT_CARD_TYPE, 
--T9.FULL_DATE_APP CREDIT_CARD_EXPIRY, 
/* EXP_DATE FORMAT IS YYMM*/
CAST(EOMONTH(CAST((case when SUBSTRING(T1.EXP_DATE,3,4)>12 then NULL
                        else '20'+LEFT(T1.EXP_DATE,2)+'-'+RIGHT(T1.EXP_DATE,2)+ '-01' END) AS DATE),0) AS DATETIME2) AS CREDIT_CARD_EXPIRY,
ltrim(rtrim(BANKID)) CREDIT_CARD_BANK_ID, 
ltrim(rtrim(TRANSACTION_NO)) BATCH_NUMBER, 
ltrim(rtrim(TID)) EXTERNAL_TRANSACTION_ID, 
ltrim(rtrim(MID)) TRANSACTION_MERCHANT_ID, 
ltrim(rtrim(SOURCE)) COLLECTION_SOURCE, 
ltrim(rtrim(REMARKS)) REMARKS, 
ltrim(rtrim(BINCODE)) BINCODE,
AMOUNT TRANSACTION_AMOUNT_LC, 
0 TRANSACTION_AMOUNT_USD , 
T1.AUTHCODE,
NULL FINGERPRINT,
NULL ERROR_MESSGAE,
NULL AS TRANSACTION_ID,
NULL AS PERSON_ID,
NULL AS CUSTOMER_ID,
NULL AS [USER_ID],
NULL AS PAYMENTMODE
FROM KIMBER_EGY_ADMIN.PG_MIGSTRANS T1 
LEFT OUTER JOIN (
     SELECT DS, USER_ID, USER_KEY, USER_NAME, ROW_NUMBER() OVER (PARTITION BY DS, USER_ID ORDER BY USER_ID) ROW_ID
     FROM EDWH_DIM.DIM_LKUP_USER WHERE DS = 2
     ) T2 ON T2.ROW_ID = 1 AND LOWER(T2.USER_NAME)=LOWER(T1.USER_ID) AND T2.DS=2 
LEFT OUTER JOIN EDWH_DIM.DIM_LKUP_CURRENCY T4 ON T4.CURRENCY_SHORT_CODE=T1.CURRENCY 
AND T4.DS=2 
--LEFT OUTER JOIN KIMBER_EGY.
--ADMIN.TIME_DIM T9 ON T9.TIME_DIM_KEY=T1.EXP_DATE 
WHERE CAST(TRANSACTIONSTARTDATE AS DATE) = DATEADD(D,DATEDIFF(D,0,@UAEDATE),0) - 1;

RAISERROR ( 'FACT_PAYMENT_GATEWAY POPULATED', 10, 1);

END;
GO


